select current_database();
select current_schema();


INSERT INTO AoC_Input (DAYNUM, INPUT_TYPE, ROWN, DAY_INPUT)
VALUES
( 5, 'T', 1, 'seeds: 79 14 55 13' ),
( 5, 'T', 2, '' ),
( 5, 'T', 3, 'seed-to-soil map:' ),
( 5, 'T', 4, '50 98 2' ),
( 5, 'T', 5, '52 50 48' ),
( 5, 'T', 6, '' ),
( 5, 'T', 7, 'soil-to-fertilizer map:' ),
( 5, 'T', 8, '0 15 37' ),
( 5, 'T', 9, '37 52 2' ),
( 5, 'T', 10, '39 0 15' ),
( 5, 'T', 11, '' ),
( 5, 'T', 12, 'fertilizer-to-water map:' ),
( 5, 'T', 13, '49 53 8' ),
( 5, 'T', 14, '0 11 42' ),
( 5, 'T', 15, '42 0 7' ),
( 5, 'T', 16, '57 7 4' ),
( 5, 'T', 17, '' ),
( 5, 'T', 18, 'water-to-light map:' ),
( 5, 'T', 19, '88 18 7' ),
( 5, 'T', 20, '18 25 70' ),
( 5, 'T', 21, '' ),
( 5, 'T', 22, 'light-to-temperature map:' ),
( 5, 'T', 23, '45 77 23' ),
( 5, 'T', 24, '81 45 19' ),
( 5, 'T', 25, '68 64 13' ),
( 5, 'T', 26, '' ),
( 5, 'T', 27, 'temperature-to-humidity map:' ),
( 5, 'T', 28, '0 69 1' ),
( 5, 'T', 29, '1 0 69' ),
( 5, 'T', 30, '' ),
( 5, 'T', 31, 'humidity-to-location map:' ),
( 5, 'T', 32, '60 56 37' ),
( 5, 'T', 33, '56 93 4' )
;

INSERT INTO AoC_Input (DAYNUM, INPUT_TYPE, ROWN, DAY_INPUT)
VALUES
( 5, 'P', 1, 'seeds: 2041142901 113138307 302673608 467797997 1787644422 208119536 143576771 99841043 4088720102 111819874 946418697 13450451 3459931852 262303791 2913410855 533641609 2178733435 26814354 1058342395 175406592' ),
( 5, 'P', 2, '' ),
( 5, 'P', 3, 'seed-to-soil map:' ),
( 5, 'P', 4, '1270068015 1235603193 242614277' ),
( 5, 'P', 5, '13415696 1478217470 21049126' ),
( 5, 'P', 6, '825250550 1160341941 75261252' ),
( 5, 'P', 7, '3786189027 1971702238 242038712' ),
( 5, 'P', 8, '3191605340 3433644052 172752250' ),
( 5, 'P', 9, '2389904665 3088515862 345128190' ),
( 5, 'P', 10, '0 1499266596 13415696' ),
( 5, 'P', 11, '1197451933 0 72616082' ),
( 5, 'P', 12, '2139929050 1721726623 249975615' ),
( 5, 'P', 13, '900511802 222541761 147014452' ),
( 5, 'P', 14, '1047526254 72616082 149925679' ),
( 5, 'P', 15, '34464822 980591812 179750129' ),
( 5, 'P', 16, '2735032855 2631943377 456572485' ),
( 5, 'P', 17, '3364357590 3606396302 421831437' ),
( 5, 'P', 18, '214214951 369556213 611035599' ),
( 5, 'P', 19, '1721726623 2213740950 418202427' ),
( 5, 'P', 20, '' ),
( 5, 'P', 21, 'soil-to-fertilizer map:' ),
( 5, 'P', 22, '226793587 358613369 356867344' ),
( 5, 'P', 23, '0 1838890301 226793587' ),
( 5, 'P', 24, '2741010192 0 358613369' ),
( 5, 'P', 25, '2257843811 715480713 173982825' ),
( 5, 'P', 26, '3099623561 1264222741 3082010' ),
( 5, 'P', 27, '1810570233 2912833547 326150077' ),
( 5, 'P', 28, '4038242924 3815312886 256724372' ),
( 5, 'P', 29, '2431826636 3268919687 279247493' ),
( 5, 'P', 30, '866869902 1671637223 167253078' ),
( 5, 'P', 31, '3102705571 889463538 374759203' ),
( 5, 'P', 32, '1615333950 2646894858 125679350' ),
( 5, 'P', 33, '2136720310 1550513722 121123501' ),
( 5, 'P', 34, '3477464774 2772574208 140259339' ),
( 5, 'P', 35, '1034122980 2065683888 581210970' ),
( 5, 'P', 36, '2711074129 3238983624 29936063' ),
( 5, 'P', 37, '583660931 1267304751 283208971' ),
( 5, 'P', 38, '1741013300 3548167180 69556933' ),
( 5, 'P', 39, '3815312886 4072037258 222930038' ),
( 5, 'P', 40, '' ),
( 5, 'P', 41, 'fertilizer-to-water map:' ),
( 5, 'P', 42, '2197389106 1911800263 305927673' ),
( 5, 'P', 43, '3117278994 244526473 20512291' ),
( 5, 'P', 44, '2957263700 4069704360 136102838' ),
( 5, 'P', 45, '1536592951 2749121858 245216219' ),
( 5, 'P', 46, '3093366538 840656765 23912456' ),
( 5, 'P', 47, '815267737 2718368501 30753357' ),
( 5, 'P', 48, '3137791285 3392529258 82147206' ),
( 5, 'P', 49, '3770129899 390297301 198889495' ),
( 5, 'P', 50, '2168252150 2217727936 29136956' ),
( 5, 'P', 51, '770420674 2367771416 44847063' ),
( 5, 'P', 52, '3304122356 4205807198 44047643' ),
( 5, 'P', 53, '94626393 318562852 71734449' ),
( 5, 'P', 54, '2518697514 2262245627 10899396' ),
( 5, 'P', 55, '1967704281 265038764 53524088' ),
( 5, 'P', 56, '846021094 2994338077 264934624' ),
( 5, 'P', 57, '1215514867 3881882833 187821527' ),
( 5, 'P', 58, '1781809170 2556752263 100818318' ),
( 5, 'P', 59, '1882627488 1690877042 85076793' ),
( 5, 'P', 60, '208796777 631622731 209034034' ),
( 5, 'P', 61, '2583608714 3508227847 39876494' ),
( 5, 'P', 62, '519341481 1587040614 19652563' ),
( 5, 'P', 63, '599791964 104559149 139967324' ),
( 5, 'P', 64, '3430004623 1246915338 340125276' ),
( 5, 'P', 65, '1110955718 0 104559149' ),
( 5, 'P', 66, '2623485208 3548104341 333778492' ),
( 5, 'P', 67, '1403336394 3259272701 133256557' ),
( 5, 'P', 68, '0 2273145023 94626393' ),
( 5, 'P', 69, '2529596910 1857788459 54011804' ),
( 5, 'P', 70, '166360842 589186796 42435935' ),
( 5, 'P', 71, '3219938491 1606693177 84183865' ),
( 5, 'P', 72, '2165362153 3505337850 2889997' ),
( 5, 'P', 73, '2021228369 2412618479 72557496' ),
( 5, 'P', 74, '538994044 2657570581 60797920' ),
( 5, 'P', 75, '739759288 3474676464 30661386' ),
( 5, 'P', 76, '417830811 1154801218 92114120' ),
( 5, 'P', 77, '509944931 864569221 9396550' ),
( 5, 'P', 78, '2093785865 2485175975 71576288' ),
( 5, 'P', 79, '3969019394 873965771 280835447' ),
( 5, 'P', 80, '2503316779 2246864892 15380735' ),
( 5, 'P', 81, '3348169999 1775953835 81834624' ),
( 5, 'P', 82, '' ),
( 5, 'P', 83, 'water-to-light map:' ),
( 5, 'P', 84, '3059617387 1101868951 93963271' ),
( 5, 'P', 85, '2772853640 2098642805 169363292' ),
( 5, 'P', 86, '193287974 683814429 1482323' ),
( 5, 'P', 87, '3780234682 1734000399 364642406' ),
( 5, 'P', 88, '194770297 193287974 490526455' ),
( 5, 'P', 89, '3550500423 902417243 199451708' ),
( 5, 'P', 90, '3466829263 2268006097 83671160' ),
( 5, 'P', 91, '3379471616 2976813583 87357647' ),
( 5, 'P', 92, '2283311570 2369871058 489542070' ),
( 5, 'P', 93, '3768145932 1195832222 12088750' ),
( 5, 'P', 94, '1202605712 3064171230 1080705858' ),
( 5, 'P', 95, '2942216932 2859413128 107440729' ),
( 5, 'P', 96, '3749952131 2351677257 18193801' ),
( 5, 'P', 97, '3049657661 2966853857 9959726' ),
( 5, 'P', 98, '902417243 1433811930 300188469' ),
( 5, 'P', 99, '3153580658 1207920972 225890958' ),
( 5, 'P', 100, '' ),
( 5, 'P', 101, 'light-to-temperature map:' ),
( 5, 'P', 102, '1088722200 1345179841 10000894' ),
( 5, 'P', 103, '4202170199 3029124889 92797097' ),
( 5, 'P', 104, '3016749137 3130683307 53232372' ),
( 5, 'P', 105, '534766220 331633133 9297796' ),
( 5, 'P', 106, '190275035 286706851 44926282' ),
( 5, 'P', 107, '3069981509 1355180735 96127340' ),
( 5, 'P', 108, '1579189291 3913052943 379484702' ),
( 5, 'P', 109, '3918942962 3793498681 21754451' ),
( 5, 'P', 110, '262413801 377451173 88614642' ),
( 5, 'P', 111, '2452226090 2443004441 143726844' ),
( 5, 'P', 112, '1958673993 2586731285 188604820' ),
( 5, 'P', 113, '2595952934 3815253132 97799811' ),
( 5, 'P', 114, '882433672 754981589 206288528' ),
( 5, 'P', 115, '608195463 3121921986 8761321' ),
( 5, 'P', 116, '393888178 145828809 140878042' ),
( 5, 'P', 117, '3166108849 1530740045 97835767' ),
( 5, 'P', 118, '351028443 139489318 6339491' ),
( 5, 'P', 119, '3410232629 961270117 222147493' ),
( 5, 'P', 120, '2449796439 4292537645 2429651' ),
( 5, 'P', 121, '2401067597 1890048598 48728842' ),
( 5, 'P', 122, '3263944616 2376148398 66856043' ),
( 5, 'P', 123, '3330800659 1451308075 79431970' ),
( 5, 'P', 124, '3632380122 2019388074 205952206' ),
( 5, 'P', 125, '1548873457 1323582243 21597598' ),
( 5, 'P', 126, '2693752745 2225340280 142089882' ),
( 5, 'P', 127, '357367934 340930929 36520244' ),
( 5, 'P', 128, '0 493278299 50785717' ),
( 5, 'P', 129, '768194739 645497224 68742488' ),
( 5, 'P', 130, '2876584504 1183417610 140164633' ),
( 5, 'P', 131, '235201317 466065815 27212484' ),
( 5, 'P', 132, '1570471055 2367430162 8718236' ),
( 5, 'P', 133, '2147278813 2775336105 253788784' ),
( 5, 'P', 134, '874238988 3335153634 8194684' ),
( 5, 'P', 135, '2835842627 714239712 40741877' ),
( 5, 'P', 136, '3838332328 1938777440 80610634' ),
( 5, 'P', 137, '50785717 0 139489318' ),
( 5, 'P', 138, '616956784 3183915679 151237955' ),
( 5, 'P', 139, '836937227 608195463 37301761' ),
( 5, 'P', 140, '1098723094 3343348318 450150363' ),
( 5, 'P', 141, '3940697413 1628575812 261472786' ),
( 5, 'P', 142, '' ),
( 5, 'P', 143, 'temperature-to-humidity map:' ),
( 5, 'P', 144, '3865679795 3411240257 137388137' ),
( 5, 'P', 145, '0 569718370 128927628' ),
( 5, 'P', 146, '2284256983 1093255418 349419361' ),
( 5, 'P', 147, '2189606444 2745948834 16886013' ),
( 5, 'P', 148, '3861728218 3796217004 3951577' ),
( 5, 'P', 149, '700036088 2134161201 67667679' ),
( 5, 'P', 150, '2639129496 1078899666 14355752' ),
( 5, 'P', 151, '4003067932 4146768977 27598493' ),
( 5, 'P', 152, '569558723 2311178479 130477365' ),
( 5, 'P', 153, '4125126694 3887925067 11822916' ),
( 5, 'P', 154, '1884679865 1442674779 129657290' ),
( 5, 'P', 155, '2633676344 1572332069 5453152' ),
( 5, 'P', 156, '862461784 1577785221 531688422' ),
( 5, 'P', 157, '4030666425 4120171499 26597478' ),
( 5, 'P', 158, '195554894 115268399 39538402' ),
( 5, 'P', 159, '235093296 235252943 334465427' ),
( 5, 'P', 160, '2132287170 698645998 57319274' ),
( 5, 'P', 161, '4158735055 3550090086 136232241' ),
( 5, 'P', 162, '2206492457 157488417 77764526' ),
( 5, 'P', 163, '3562496130 3899747983 220423516' ),
( 5, 'P', 164, '2653485248 2201828880 109349599' ),
( 5, 'P', 165, '2014337155 154806801 2681616' ),
( 5, 'P', 166, '1580787383 2536413861 97415145' ),
( 5, 'P', 167, '3453031511 3880534101 7390966' ),
( 5, 'P', 168, '1394150206 2633829006 45492562' ),
( 5, 'P', 169, '4057263903 3686322327 7821024' ),
( 5, 'P', 170, '4157273363 3548628394 1461692' ),
( 5, 'P', 171, '3460422477 3694143351 102073653' ),
( 5, 'P', 172, '4136949610 3800168581 20323753' ),
( 5, 'P', 173, '1678202528 872422329 206477337' ),
( 5, 'P', 174, '1556099825 2109473643 24687558' ),
( 5, 'P', 175, '128927628 2679321568 66627266' ),
( 5, 'P', 176, '2017018771 0 115268399' ),
( 5, 'P', 177, '4065084927 3820492334 60041767' ),
( 5, 'P', 178, '3411240257 4253176042 41791254' ),
( 5, 'P', 179, '767703767 2441655844 94758017' ),
( 5, 'P', 180, '1439642768 755965272 116457057' ),
( 5, 'P', 181, '3782919646 4174367470 78808572' ),
( 5, 'P', 182, '' ),
( 5, 'P', 183, 'humidity-to-location map:' ),
( 5, 'P', 184, '347042062 4204488573 2962316' ),
( 5, 'P', 185, '877642375 2878291222 23518224' ),
( 5, 'P', 186, '3638916554 3484768713 5466055' ),
( 5, 'P', 187, '2890676240 3280663590 83564486' ),
( 5, 'P', 188, '201731623 3228655138 52008452' ),
( 5, 'P', 189, '1692198890 1946017811 25211210' ),
( 5, 'P', 190, '1717410100 1270737209 92827656' ),
( 5, 'P', 191, '3598929376 3630765534 39987178' ),
( 5, 'P', 192, '2226479211 1578430526 262844314' ),
( 5, 'P', 193, '687169155 3670752712 117494406' ),
( 5, 'P', 194, '3884728324 1515480569 62949957' ),
( 5, 'P', 195, '3494186405 1841274840 104742971' ),
( 5, 'P', 196, '2753482998 2630924017 120642845' ),
( 5, 'P', 197, '572458731 2235388494 114710424' ),
( 5, 'P', 198, '3947678281 3490234768 140530766' ),
( 5, 'P', 199, '3433348031 3167816764 60838374' ),
( 5, 'P', 200, '350004378 2406580589 222454353' ),
( 5, 'P', 201, '804663561 1442501755 72978814' ),
( 5, 'P', 202, '4132461733 2901809446 35781203' ),
( 5, 'P', 203, '4088209047 2937590649 38937925' ),
( 5, 'P', 204, '1441554453 2350098918 56481671' ),
( 5, 'P', 205, '3644382609 201731623 240345715' ),
( 5, 'P', 206, '2489323525 1971229021 264159473' ),
( 5, 'P', 207, '2974240726 3086380958 81435806' ),
( 5, 'P', 208, '4127146972 3364228076 5314761' ),
( 5, 'P', 209, '901160599 4207450889 87516407' ),
( 5, 'P', 210, '988677006 442077338 350976352' ),
( 5, 'P', 211, '1498036124 3369542837 115225876' ),
( 5, 'P', 212, '1810237756 3788247118 416241455' ),
( 5, 'P', 213, '1613262000 1363564865 78936890' ),
( 5, 'P', 214, '253740075 2993078971 93301987' ),
( 5, 'P', 215, '3055676532 894954785 375782424' ),
( 5, 'P', 216, '1339653358 793053690 101901095' ),
( 5, 'P', 217, '2874125843 2976528574 16550397' ),
( 5, 'P', 218, '3431458956 2629034942 1889075' ),
( 5, 'P', 219, '4168242936 2751566862 126724360' )
;

with base as (
	select 
		rown
		, day_input 
	from AoC_Input 
	where daynum = 5 and input_type = 'P'
), seeds as (
	select  
		regexp_split_to_table(substr(day_input, 8, 1000), '\s+')::BIGINT as seed
	from base 
	where left(day_input, 5) = 'seeds' 
), seed_soil_pre as(
	select 
		rown 
		, regexp_matches(day_input, '(\d+)\s+(\d+)\s+(\d+)', 'g') as matches
	from base 
	where rown between (select rown from base where day_input like '%seed-to-soil%') +1
				and    (select rown from base where day_input like '%soil-to-fertilizer%')-2
), seed_soil as(
	select 
		rown
		, matches[1]::BIGINT as dst_rng_start
		, matches[2]::BIGINT as src_rng_start
		, matches[3]::BIGINT as rng_len 
	from seed_soil_pre
), soil_fert_pre as(
	select 
		rown 
		, regexp_matches(day_input, '(\d+)\s+(\d+)\s+(\d+)', 'g') as matches
	from base 
	where rown between (select rown from base where day_input like '%soil-to-fertilizer%') +1
				and    (select rown from base where day_input like '%fertilizer-to-water%')-2
), soil_fert as(
	select 
		rown
		, matches[1]::BIGINT as dst_rng_start
		, matches[2]::BIGINT as src_rng_start
		, matches[3]::BIGINT as rng_len 
	from soil_fert_pre
), fert_water_pre as(
	select 
		rown 
		, regexp_matches(day_input, '(\d+)\s+(\d+)\s+(\d+)', 'g') as matches
	from base 
	where rown between (select rown from base where day_input like '%fertilizer-to-water%') +1
				and    (select rown from base where day_input like '%water-to-light%')-2
), fert_water as(
	select 
		rown
		, matches[1]::BIGINT as dst_rng_start
		, matches[2]::BIGINT as src_rng_start
		, matches[3]::BIGINT as rng_len 
	from fert_water_pre
), water_lig_pre as(
	select 
		rown 
		, regexp_matches(day_input, '(\d+)\s+(\d+)\s+(\d+)', 'g') as matches
	from base 
	where rown between (select rown from base where day_input like '%water-to-light%') +1
				and    (select rown from base where day_input like '%light-to-temp%')-2
), water_lig as(
	select 
		rown
		, matches[1]::BIGINT as dst_rng_start
		, matches[2]::BIGINT as src_rng_start
		, matches[3]::BIGINT as rng_len 
	from water_lig_pre
), lig_temp_pre as(
	select 
		rown 
		, regexp_matches(day_input, '(\d+)\s+(\d+)\s+(\d+)', 'g') as matches
	from base 
	where rown between (select rown from base where day_input like '%light-to-temp%') +1
				and    (select rown from base where day_input like '%temperature-to-hum%')-2
), lig_temp as(
	select 
		rown
		, matches[1]::BIGINT as dst_rng_start
		, matches[2]::BIGINT as src_rng_start
		, matches[3]::BIGINT as rng_len 
	from lig_temp_pre
), temp_hum_pre as(
	select 
		rown 
		, regexp_matches(day_input, '(\d+)\s+(\d+)\s+(\d+)', 'g') as matches
	from base 
	where rown between (select rown from base where day_input like '%temperature-to-hum%') +1
				and    (select rown from base where day_input like '%humidity-to-location%')-2
), temp_hum as(
	select 
		rown
		, matches[1]::BIGINT as dst_rng_start
		, matches[2]::BIGINT as src_rng_start
		, matches[3]::BIGINT as rng_len 
	from temp_hum_pre
), hum_loc_pre as(
	select 
		rown 
		, regexp_matches(day_input, '(\d+)\s+(\d+)\s+(\d+)', 'g') as matches
	from base 
	where rown between (select rown from base where day_input like '%humidity-to-location%') +1
				and    (select count(*) from base)
), hum_loc as(
	select 
		rown
		, matches[1]::BIGINT as dst_rng_start
		, matches[2]::BIGINT as src_rng_start
		, matches[3]::BIGINT as rng_len 
	from hum_loc_pre
), soil as (
	select 
	   coalesce(seed_soil.dst_rng_start + seeds.seed -seed_soil.src_rng_start, seeds.seed) as soil
	from seeds 
	left join seed_soil 
		on seeds.seed between seed_soil.src_rng_start and seed_soil.src_rng_start + seed_soil.rng_len -1
), fert as (
	select 
	   coalesce(soil_fert.dst_rng_start + soil.soil - soil_fert.src_rng_start, soil.soil) as fert
	from soil 
	left join soil_fert 
		on soil.soil between soil_fert.src_rng_start and soil_fert.src_rng_start + soil_fert.rng_len -1
), water as (
	select 
	   coalesce(fert_water.dst_rng_start + fert.fert - fert_water.src_rng_start, fert.fert) as water
	from fert 
	left join fert_water
		on fert.fert between fert_water.src_rng_start and fert_water.src_rng_start + fert_water.rng_len -1
), lig as (
	select 
	   coalesce(water_lig.dst_rng_start + water.water - water_lig.src_rng_start, water.water) as lig
	from water 
	left join water_lig
		on water.water between water_lig.src_rng_start and water_lig.src_rng_start + water_lig.rng_len -1
), tempe as (
	select 
	   coalesce(lig_temp.dst_rng_start + lig.lig - lig_temp.src_rng_start, lig.lig) as tempe
	from lig 
	left join lig_temp
		on lig.lig between lig_temp.src_rng_start and lig_temp.src_rng_start + lig_temp.rng_len -1
), hum as (
	select 
	   coalesce(temp_hum.dst_rng_start + tempe.tempe - temp_hum.src_rng_start, tempe.tempe) as hum
	from tempe 
	left join temp_hum
		on tempe.tempe between temp_hum.src_rng_start and temp_hum.src_rng_start + temp_hum.rng_len -1
), loc as (
	select 
	   coalesce(hum_loc.dst_rng_start + hum.hum - hum_loc.src_rng_start, hum.hum) as loc
	from hum 
	left join hum_loc
		on hum.hum between hum_loc.src_rng_start and hum_loc.src_rng_start + hum_loc.rng_len -1
)  select min(loc) as Solution01
from loc

;
